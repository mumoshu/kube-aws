
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Step 6: Configure Add-ons Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/site.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="step-7-destroy.html" />
    
    
    <link rel="prev" href="step-5-add-node-pool.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Home
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="./">
            
                <a href="./">
            
                    
                    Getting Started
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="prerequisites.html">
            
                <a href="prerequisites.html">
            
                    
                    Prerequisites
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="step-1-configure.html">
            
                <a href="step-1-configure.html">
            
                    
                    Step 1: Configure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="step-2-render.html">
            
                <a href="step-2-render.html">
            
                    
                    Step 2: Render
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="step-3-launch.html">
            
                <a href="step-3-launch.html">
            
                    
                    Step 3: Launch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="step-4-update.html">
            
                <a href="step-4-update.html">
            
                    
                    Step 4: Update
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="step-5-add-node-pool.html">
            
                <a href="step-5-add-node-pool.html">
            
                    
                    Step 5: Add Node Pool
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.7" data-path="step-6-configure-add-ons.html">
            
                <a href="step-6-configure-add-ons.html">
            
                    
                    Step 6: Configure Add-ons
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="step-7-destroy.html">
            
                <a href="step-7-destroy.html">
            
                    
                    Step 7: Destroy
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../getting-in-touch.html">
            
                <a href="../getting-in-touch.html">
            
                    
                    Getting In Touch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../cli-reference/">
            
                <a href="../cli-reference/">
            
                    
                    CLI Reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../cli-reference/aws-credentials.html">
            
                <a href="../cli-reference/aws-credentials.html">
            
                    
                    AWS Credentials
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../add-ons/">
            
                <a href="../add-ons/">
            
                    
                    Add-ons
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../add-ons/cluster-resource-backup-to-s3.html">
            
                <a href="../add-ons/cluster-resource-backup-to-s3.html">
            
                    
                    Cluster Resource Backup to AWS S3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../add-ons/journald-logging-to-cloudwatch.html">
            
                <a href="../add-ons/journald-logging-to-cloudwatch.html">
            
                    
                    Journald Logging to AWS CloudWatch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../guides/">
            
                <a href="../guides/">
            
                    
                    Guides
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../guides/operator-guide.html">
            
                <a href="../guides/operator-guide.html">
            
                    
                    Operator Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../guides/contributor-guide.html">
            
                <a href="../guides/contributor-guide.html">
            
                    
                    Contributor Guide
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../advanced-topics/">
            
                <a href="../advanced-topics/">
            
                    
                    Advanced Topics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../advanced-topics/etcd-backup-and-restore.html">
            
                <a href="../advanced-topics/etcd-backup-and-restore.html">
            
                    
                    etcd Backup & Restore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../advanced-topics/cloudformation-updates-in-cli.html">
            
                <a href="../advanced-topics/cloudformation-updates-in-cli.html">
            
                    
                    CloudFormation Updates in CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../advanced-topics/use-an-existing-vpc.html">
            
                <a href="../advanced-topics/use-an-existing-vpc.html">
            
                    
                    Use An Existing VPC
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../troubleshooting/">
            
                <a href="../troubleshooting/">
            
                    
                    Troubleshooting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../troubleshooting/known-limitations.html">
            
                <a href="../troubleshooting/known-limitations.html">
            
                    
                    Known Limitations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../troubleshooting/common-problems.html">
            
                <a href="../troubleshooting/common-problems.html">
            
                    
                    Common Problems
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../tutorials/quick-start.html">
            
                <a href="../tutorials/quick-start.html">
            
                    
                    Quick Start (WIP)
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Step 6: Configure Add-ons</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="configuring-kubernetes-add-ons">Configuring Kubernetes Add-ons</h1>
<p>kube-aws has built-in supports for several Kubernetes add-ons known to require additional configurations beforehand.</p>
<h2 id="cluster-autoscaler">cluster-autoscaler</h2>
<p><a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" target="_blank">cluster-autoscaler</a> is an add-on which automatically
scales in/out your k8s cluster by removing/adding worker nodes according to resource utilization per node.</p>
<p>To enable cluster-autoscaler, add the below settings to your cluster.yaml:</p>
<pre class="language-"><code class="lang-yaml"><span class="token key atrule">addons</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterAutoscaler</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">worker</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodePools</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> scaled
    <span class="token key atrule">autoScalingGroup</span><span class="token punctuation">:</span>
      <span class="token key atrule">minSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">autoscaling</span><span class="token punctuation">:</span>
      <span class="token key atrule">clusterAutoscaler</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> notScaled
    <span class="token key atrule">autoScalingGroup</span><span class="token punctuation">:</span>
      <span class="token key atrule">minSize</span><span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token key atrule">maxSize</span><span class="token punctuation">:</span> <span class="token number">4</span>
</code></pre>
<p>The above example configuration would:</p>
<ul>
<li>By <code>addons.clusterAutoscaler.enabled</code>:<ul>
<li>Provide controller nodes appropriate IAM permissions to call necessary AWS APIs from CA</li>
<li>Create a k8s deployment to run CA on one of controller nodes, so that CA can utilize the IAM permissions</li>
</ul>
</li>
<li>By <code>worker.nodePools[0].autoscaling.clusterAutoscaler.enabled</code>:<ul>
<li>If there are unschedulable, pending pod(s) that is requesting more capacity, CA will add more nodes to the <code>scaled</code> node pool, up until the max size <code>10</code></li>
<li>If there are no unschdulable, pending pod(s) that is waiting for more capacity and one or more nodes are in low utlization, CA will remove node(s), down until the min size <code>1</code></li>
</ul>
</li>
<li>The second node pool <code>notScaled</code> is scaled manually by YOU, because you had not the autoscaling on it(=missing <code>autoscaling.clusterAutoscaler.enabled</code>)</li>
</ul>
<h2 id="kube2iam">kube2iam</h2>
<p><a href="https://github.com/jtblin/kube2iam" target="_blank">kube2iam</a> is an add-on which provides IAM credentials for target IAM roles to pods running inside a Kubernetes cluster based on annotations.
To allow kube2iam deployed to worker and controller nodes to assume target roles, you need the following configurations.</p>
<ol>
<li><p>IAM roles associated to worker and controller nodes requires an IAM policy:</p>
<pre class="language-"><code class="lang-json"><span class="token punctuation">{</span>
 <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sts:AssumeRole&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
 <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>To add the policy to controller nodes, set <code>experimental.kube2IamSupport.enabled</code> to <code>true</code> in your <code>cluster.yaml</code>.
For worker nodes, it is <code>worker.nodePools[].kube2IamSupport.enabled</code>.</p>
</li>
<li><p>Target IAM roles needs to change trust relationships to allow kube-aws worker/controller IAM role to assume the target roles.</p>
<p>As CloudFormation generates unpredictable role names containing random IDs by default, it is recommended to make them predictable at first so that you can easily automate configuring trust relationships afterwards.
To make worker/controller role names predictable, set <code>controller.managedIamRoleName</code> for controller and <code>worker.nodePools[].managedIamRoleName</code> for worker nodes.
<code>managedIamRoleName</code>s becomes suffixes of the resulting worker/controller role names. </p>
<p>Please beware that configuration of target roles&apos; trust relationships are out-of-scope of kube-aws.
Please see <a href="https://github.com/jtblin/kube2iam#iam-roles" target="_blank">the part of kube2iam doc</a> for more information. Basically,
you need to point <code>Principal</code> to the ARN of a resulting worker/controller IAM role which would look like <code>arn:aws:iam::<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>your</span> <span class="token attr-name">aws</span> <span class="token attr-name">account</span> <span class="token attr-name">id</span><span class="token punctuation">&gt;</span></span>:role/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack-name</span><span class="token punctuation">&gt;</span></span>-<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>managed</span> <span class="token attr-name">iam</span> <span class="token attr-name">role</span> <span class="token attr-name">name</span><span class="token punctuation">&gt;</span></span></code>. </p>
</li>
</ol>
<p>Finally, an example <code>cluster.yaml</code> usable with kube2iam would look like:</p>
<pre class="language-"><code class="lang-yaml"><span class="token comment" spellcheck="true"># for controller nodes</span>
<span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">managedIamRoleName</span><span class="token punctuation">:</span> mycontrollerrole

<span class="token key atrule">experimental</span><span class="token punctuation">:</span>
  <span class="token key atrule">kube2IamSupport</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment" spellcheck="true"># for worker nodes</span>
<span class="token key atrule">worker</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodePools</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mypool
    <span class="token key atrule">managedIamRoleName</span><span class="token punctuation">:</span> myworkerrole
    <span class="token key atrule">kube2IamSupport</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre>
<p>See <a href="https://github.com/kubernetes-incubator/kube-aws/issues/253" target="_blank">the relevant GitHub issue</a> for more information.</p>
<p>You can reference controller and worker IAM Roles in a separate CloudFormation stack that provides roles to assume:</p>
<pre class="language-"><code class="lang-yaml"><span class="token punctuation">...</span>
<span class="token key atrule">Parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">KubeAWSStackName</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String
<span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">IAMRole</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>IAM<span class="token punctuation">:</span><span class="token punctuation">:</span>Role
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>
        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Action</span><span class="token punctuation">:</span> sts<span class="token punctuation">:</span>AssumeRole
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">Service</span><span class="token punctuation">:</span> ec2.amazonaws.com
          <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Action</span><span class="token punctuation">:</span> sts<span class="token punctuation">:</span>AssumeRole
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">AWS</span><span class="token punctuation">:</span>
                <span class="token key atrule">Fn::ImportValue</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> <span class="token string">&quot;${KubeAWSStackName}-ControllerIAMRoleArn&quot;</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Action</span><span class="token punctuation">:</span> sts<span class="token punctuation">:</span>AssumeRole
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">AWS</span><span class="token punctuation">:</span>
                <span class="token key atrule">Fn::ImportValue</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> <span class="token string">&quot;${KubeAWSStackName}-NodePool&lt;Node Pool Name&gt;WorkerIAMRoleArn&quot;</span>
      <span class="token punctuation">...</span>
</code></pre>
<p>When you are done with your cluster, <a href="kubernetes-on-aws-destroy.md">destroy your cluster</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="step-5-add-node-pool.html" class="navigation navigation-prev " aria-label="Previous page: Step 5: Add Node Pool">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="step-7-destroy.html" class="navigation navigation-next " aria-label="Next page: Step 7: Destroy">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Step 6: Configure Add-ons","level":"1.2.7","depth":2,"next":{"title":"Step 7: Destroy","level":"1.2.8","depth":2,"path":"getting-started/step-7-destroy.md","ref":"getting-started/step-7-destroy.md","articles":[]},"previous":{"title":"Step 5: Add Node Pool","level":"1.2.6","depth":2,"path":"getting-started/step-5-add-node-pool.md","ref":"getting-started/step-5-add-node-pool.md","articles":[]},"dir":"ltr"},"config":{"plugins":["edit-link","prism","-highlight","github","anchorjs"],"root":"docs","styles":{"website":"styles/site.css"},"pluginsConfig":{"prism":{},"github":{"url":"https://github.com/kubernetes-incubator/kube-aws"},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"edit-link":{"label":"Edit This Page","base":"https://github.com/kube-aws/docs/tree/master"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchorjs":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"links":{"sidebar":{}},"gitbook":"*"},"file":{"path":"getting-started/step-6-configure-add-ons.md","mtime":"2017-08-23T05:48:10.386Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-08-23T05:50:22.787Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.1/anchor.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-anchorjs/anchor-style.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

